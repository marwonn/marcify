<!DOCTYPE html>
<html lang="en">
<head>
  <title>Playlist Generator</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
  <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="../static/css/site.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <style>
    .playlist-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 14px;
      padding: 4px;
    }
    .playlist-tile {
      position: relative;
      cursor: pointer;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid transparent;
      transition: all 0.2s;
      -webkit-tap-highlight-color: rgba(29, 185, 84, 0.3);
    }
    .playlist-tile::before {
      content: '';
      display: block;
      padding-top: 100%;
    }
    .playlist-tile-img {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    .playlist-tile-label {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      padding: 28px 8px 8px;
      background: linear-gradient(transparent, rgba(0,0,0,0.85));
      font-size: 13px;
      line-height: 1.3;
    }
    .playlist-tile-label strong {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .playlist-tile-label small {
      opacity: 0.7;
    }
    .playlist-tile:hover,
    .playlist-tile:active {
      border-color: #555;
      transform: scale(1.02);
    }
    .playlist-tile.selected {
      border-color: #1db954;
      box-shadow: 0 0 0 2px #1db954;
    }
    .score-bar {
      height: 24px;
      background: linear-gradient(to right, #3498db, #1db954);
      border-radius: 6px;
    }
    .score-bar-container {
      background-color: #2c3e50;
      border-radius: 6px;
      overflow: hidden;
    }
    .mood-tag {
      display: inline-block;
      padding: 8px 14px;
      margin: 4px;
      background-color: #1db954;
      border-radius: 20px;
      font-size: 13px;
    }
    .step-card {
      background-color: #1a1a2e;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background-color: #1db954;
      border-radius: 50%;
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .step-header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .step-header h4 {
      margin: 0;
      flex: 1;
      min-width: 200px;
    }
    .step-card.collapsed {
      cursor: pointer;
    }
    .step-card.collapsed .step-content {
      display: none;
    }
    .step-card .collapsed-summary {
      display: none;
      color: #1db954;
      font-size: 0.95rem;
      margin-left: 42px;
    }
    .step-card.collapsed .collapsed-summary {
      display: block;
    }
    .step-card.collapsed .step-header::after {
      content: '(tap to change)';
      font-size: 0.8rem;
      color: #888;
      margin-left: 10px;
    }
    .progress-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      gap: 8px;
    }
    .progress-step {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: #2c3e50;
      color: #888;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s;
    }
    .progress-step.active {
      background-color: #1db954;
      color: white;
    }
    .progress-step.completed {
      background-color: #1db954;
      color: white;
    }
    .progress-line {
      width: 40px;
      height: 3px;
      background-color: #2c3e50;
      transition: background-color 0.3s;
    }
    .progress-line.completed {
      background-color: #1db954;
    }
    #mood-profile {
      display: none;
    }
    #generator-settings {
      display: none;
    }
    .song-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #333;
      min-height: 60px;
    }
    .song-item img {
      width: 48px;
      height: 48px;
      margin-right: 12px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .song-info {
      min-width: 0;
      overflow: hidden;
    }
    .song-info strong {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .song-info small {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Mobile specific */
    @media (max-width: 768px) {
      .playlist-grid {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 10px;
      }
      .step-card {
        padding: 14px;
        border-radius: 10px;
        margin-bottom: 10px;
      }
      .step-header h4 {
        font-size: 1.1rem;
      }
      .progress-indicator {
        margin-bottom: 14px;
      }
      .progress-step {
        width: 30px;
        height: 30px;
        font-size: 12px;
      }
      .progress-line {
        width: 30px;
      }
      #playlists-container {
        max-height: 50vh !important;
      }
      .mood-scores-container,
      .mood-tags-container {
        margin-bottom: 1rem;
      }
      #generated-songs {
        max-height: 50vh !important;
      }
      .slider-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .slider-value {
        background: #1db954;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.9rem;
        min-width: 36px;
        text-align: center;
      }
    }
    @media (max-width: 400px) {
      .playlist-grid {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 8px;
      }
      .playlist-tile-label {
        font-size: 11px;
        padding: 20px 6px 6px;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
    <a class="navbar-brand" href="{{ url_for('landing') }}">marcify</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
          <a class="nav-link" href="{{ url_for('index') }}">Generator</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('music_profile') }}">My Profile</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container mt-4">
    <!-- Progress Indicator -->
    <div class="progress-indicator">
      <div class="progress-step active" id="prog-1">1</div>
      <div class="progress-line" id="prog-line-1"></div>
      <div class="progress-step" id="prog-2">2</div>
      <div class="progress-line" id="prog-line-2"></div>
      <div class="progress-step" id="prog-3">3</div>
    </div>
    <!-- Step 1: Select Playlist -->
    <div class="step-card" id="step-1">
      <div class="step-header mb-2">
        <span class="step-number">1</span>
        <h4>Select a Playlist</h4>
      </div>
      <div class="collapsed-summary" id="step-1-summary"></div>
      <div class="step-content">
        <p class="text-muted small mb-2">Choose a playlist as your mood template</p>

        <div id="playlists-loading" class="text-center py-4">
          <p>Loading your playlists...</p>
        </div>

        <div id="playlists-container" style="max-height: 350px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
          <!-- Playlists will be loaded here -->
        </div>

        <button id="analyze-playlist-btn" class="btn btn-primary btn-block btn-lg mt-3" disabled>
          Analyze Selected Playlist
        </button>
      </div>
    </div>

    <!-- Step 2: Mood Profile -->
    <div class="step-card" id="mood-profile">
      <div class="step-header mb-2">
        <span class="step-number">2</span>
        <h4>Mood Profile</h4>
      </div>
      <div class="collapsed-summary" id="step-2-summary"></div>
      <div class="step-content">
        <p class="text-muted small mb-2">Based on <strong id="analyzed-playlist-name"></strong></p>

        <div class="row">
          <div class="col-12 col-md-6 mood-scores-container">
            <h5 class="mb-3">Mood Scores</h5>
            <div id="mood-scores"></div>
          </div>
          <div class="col-12 col-md-6 mood-tags-container">
            <h5 class="mb-3">Top Tags</h5>
            <div id="mood-tags"></div>
          </div>
        </div>

        <button id="continue-to-generator" class="btn btn-success btn-block btn-lg mt-4">
          Continue to Generator
        </button>
      </div>
    </div>

    <!-- Step 3: Generator Settings -->
    <div class="step-card" id="generator-settings">
      <div class="step-header mb-2">
        <span class="step-number">3</span>
        <h4>Generate Playlist</h4>
      </div>
      <p class="text-muted small mb-3">Combine mood profile with your preferences</p>

      <div class="row">
        <div class="col-12 col-md-6 mb-4">
          <div class="form-group">
            <label for="seed-artist" class="mb-2">Seed Artist</label>
            <input type="text" id="seed-artist" class="form-control" placeholder="e.g. Radiohead, Daft Punk..." autocomplete="off" autocorrect="off" autocapitalize="off">
            <small class="text-muted">Adds similar artists to your playlist</small>
          </div>

          <div class="form-group">
            <div class="slider-label">
              <span>Variety</span>
              <span class="slider-value" id="variety-value">5</span>
            </div>
            <input type="range" min="1" max="10" step="1" class="form-control-range" id="variety" value="5">
            <small class="text-muted">More variety = more different artists</small>
          </div>

          <div class="form-group">
            <div class="slider-label">
              <span>Discovery</span>
              <span class="slider-value" id="discovery-value">5</span>
            </div>
            <input type="range" min="1" max="10" step="1" class="form-control-range" id="discovery" value="5">
            <small class="text-muted">1 = mood profile, 10 = seed artist</small>
          </div>

          <div class="form-group">
            <label for="track-count" class="mb-2">Number of Tracks</label>
            <input type="number" class="form-control" id="track-count" value="15" min="5" max="30" inputmode="numeric">
          </div>

          <button id="generate-playlist-btn" class="btn btn-success btn-block btn-lg">
            Generate Playlist
          </button>
        </div>

        <div class="col-12 col-md-6">
          <h5 class="mb-3">Generated Playlist</h5>
          <div id="generated-songs" style="max-height: 400px; overflow-y: auto; -webkit-overflow-scrolling: touch;">
            <p class="text-muted text-center py-4">Click "Generate" to see recommendations</p>
          </div>

          <button id="save-playlist-btn" class="btn btn-primary btn-block btn-lg mt-3" style="display: none;">
            Save to Spotify
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal fade" id="saveModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header" style="background-color: #1db954;">
          <h5 class="modal-title" style="color: white"><strong>Saved!</strong></h5>
          <button type="button" class="close" style="color: white" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <span style="color: black">Your new playlist was saved to Spotify!</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    var selectedPlaylistId = null;
    var selectedPlaylistName = null;
    var generatedUris = [];

    // Load playlists on page load
    $(document).ready(function() {
      loadPlaylists();

      // Update slider value displays
      $('#variety').on('input', function() {
        $('#variety-value').text($(this).val());
      });
      $('#discovery').on('input', function() {
        $('#discovery-value').text($(this).val());
      });
    });

    function loadPlaylists() {
      $.get('/api/playlists', function(response) {
        $('#playlists-loading').hide();

        if (response.playlists && response.playlists.length > 0) {
          var html = '<div class="playlist-grid">';
          response.playlists.forEach(function(pl) {
            var img = pl.image || 'https://via.placeholder.com/300/1a1a2e/555?text=â™ª';
            var safeName = $('<div>').text(pl.name).html();
            html += '<div class="playlist-tile" data-id="' + pl.id + '" data-name="' + safeName + '">';
            html += '<img src="' + img + '" class="playlist-tile-img" alt="">';
            html += '<div class="playlist-tile-label">';
            html += '<strong>' + safeName + '</strong>';
            html += '<small>' + pl.tracks_total + ' tracks</small>';
            html += '</div></div>';
          });
          html += '</div>';
          $('#playlists-container').html(html);
        } else {
          $('#playlists-container').html('<p class="text-muted text-center py-4">No playlists found</p>');
        }
      }).fail(function(xhr) {
        $('#playlists-loading').hide();
        if (xhr.status === 401) {
          window.location.href = '/generator';
        } else {
          $('#playlists-container').html('<p class="text-danger">Error loading playlists</p>');
        }
      });
    }

    // Select playlist
    $(document).on('click', '.playlist-tile', function() {
      $('.playlist-tile').removeClass('selected');
      $(this).addClass('selected');
      selectedPlaylistId = $(this).data('id');
      selectedPlaylistName = $(this).data('name');
      $('#analyze-playlist-btn').prop('disabled', false);
    });

    // Update progress indicator
    function updateProgress(step) {
      // Reset all
      $('.progress-step').removeClass('active completed');
      $('.progress-line').removeClass('completed');

      // Mark completed steps
      for (var i = 1; i < step; i++) {
        $('#prog-' + i).addClass('completed');
        $('#prog-line-' + i).addClass('completed');
      }
      // Mark current step active
      $('#prog-' + step).addClass('active');
    }

    // Analyze playlist
    $('#analyze-playlist-btn').click(function(e) {
      e.stopPropagation(); // Prevent triggering collapsed handler
      if (!selectedPlaylistId) return;

      $(this).prop('disabled', true).text('Analyzing...');

      $.get('/api/playlist/' + selectedPlaylistId + '/analyze', function(response) {
        $('#analyze-playlist-btn').prop('disabled', false).text('Analyze Selected Playlist');

        // Update progress
        updateProgress(2);

        // Collapse step 1 and set summary
        $('#step-1').addClass('collapsed');
        $('#step-1-summary').text(selectedPlaylistName);

        // Show mood profile
        $('#analyzed-playlist-name').text(selectedPlaylistName);

        // Render scores
        var scoresHtml = '';
        for (var category in response.scores) {
          var score = response.scores[category];
          var percent = Math.round(score * 100);
          scoresHtml += '<div class="mb-2">';
          scoresHtml += '<div class="d-flex justify-content-between"><span>' + category.charAt(0).toUpperCase() + category.slice(1) + '</span><span>' + percent + '%</span></div>';
          scoresHtml += '<div class="score-bar-container"><div class="score-bar" style="width: ' + percent + '%;"></div></div>';
          scoresHtml += '</div>';
        }
        $('#mood-scores').html(scoresHtml);

        // Render tags
        var tagsHtml = '';
        response.top_tags.slice(0, 10).forEach(function(tag) {
          tagsHtml += '<span class="mood-tag">' + tag[0] + '</span>';
        });
        $('#mood-tags').html(tagsHtml);

        $('#mood-profile').slideDown();
        $('html, body').animate({
          scrollTop: $('#mood-profile').offset().top - 20
        }, 300);
      }).fail(function(xhr) {
        $('#analyze-playlist-btn').prop('disabled', false).text('Analyze Selected Playlist');
        if (xhr.status === 401) {
          alert('Session expired. Please log in again.');
          window.location.href = '/generator';
        } else {
          alert('Error analyzing playlist. Please try again.');
        }
      });
    });

    // Continue to generator
    $('#continue-to-generator').click(function(e) {
      e.stopPropagation(); // Prevent triggering collapsed handler

      // Update progress
      updateProgress(3);

      // Collapse step 2 and set summary
      $('#mood-profile').addClass('collapsed');
      var topTags = [];
      $('#mood-tags .mood-tag').slice(0, 3).each(function() {
        topTags.push($(this).text());
      });
      $('#step-2-summary').text(topTags.join(', '));

      $('#generator-settings').slideDown();
      $('html, body').animate({
        scrollTop: $('#generator-settings').offset().top - 20
      }, 300);
    });

    // Click on collapsed step to expand it
    $(document).on('click', '.step-card.collapsed', function() {
      var $this = $(this);
      var stepId = $this.attr('id');

      // Expand this step
      $this.removeClass('collapsed');

      // Collapse following steps and hide them
      if (stepId === 'step-1') {
        $('#mood-profile').addClass('collapsed').hide();
        $('#generator-settings').hide();
        updateProgress(1);
      } else if (stepId === 'mood-profile') {
        $('#generator-settings').hide();
        updateProgress(2);
      }
    });

    // Generate playlist
    $('#generate-playlist-btn').click(function() {
      $(this).prop('disabled', true).text('Generating...');

      var payload = {
        'playlist_id': selectedPlaylistId,
        'seed_artist': $('#seed-artist').val(),
        'variety': $('#variety').val(),
        'discovery': $('#discovery').val(),
        'track_count': $('#track-count').val()
      };

      $.ajax({
        type: 'POST',
        url: '/generate-from-playlist',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function(response) {
          generatedUris = JSON.parse(response.uris);

          var songsHtml = '';
          response.songs.forEach(function(song) {
            var artists = song.artists.map(function(a) { return a.name; }).join(', ');
            var albumImg = song.album && song.album.images && song.album.images[2]
              ? song.album.images[2].url : '';

            songsHtml += '<div class="song-item">';
            if (albumImg) {
              songsHtml += '<img src="' + albumImg + '" alt="">';
            }
            songsHtml += '<div class="song-info"><strong>' + song.name + '</strong><small class="text-muted">' + artists + '</small></div>';
            songsHtml += '</div>';
          });

          $('#generated-songs').html(songsHtml);
          $('#save-playlist-btn').show();
          $('#generate-playlist-btn').prop('disabled', false).text('Generate Playlist');
        },
        error: function(xhr) {
          if (xhr.status === 401) {
            alert('Session expired. Please log in again.');
            window.location.href = '/generator';
          } else {
            alert('Error generating playlist. Please try again.');
          }
          $('#generate-playlist-btn').prop('disabled', false).text('Generate Playlist');
        }
      });
    });

    // Save playlist
    $('#save-playlist-btn').click(function() {
      if (generatedUris.length === 0) return;

      $(this).prop('disabled', true).text('Saving...');

      $.ajax({
        type: 'POST',
        url: '/save-private-playlist',
        contentType: 'application/json',
        data: JSON.stringify({
          'uris': generatedUris,
          'name': 'Generated from ' + selectedPlaylistName
        }),
        success: function() {
          $('#saveModal').modal('show');
          $('#save-playlist-btn').prop('disabled', false).text('Save to Spotify');
        },
        error: function(xhr) {
          if (xhr.status === 401) {
            alert('Session expired. Please log in again.');
            window.location.href = '/generator';
          } else {
            alert('Error saving playlist. Please try again.');
          }
          $('#save-playlist-btn').prop('disabled', false).text('Save to Spotify');
        }
      });
    });
  </script>
</body>
</html>
